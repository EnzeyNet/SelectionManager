!function(a){"use strict";var b="nzSelect",c="nzDeselect",d="nzSoftSelect",e="nzSoftDeselect",f=a.module("net.enzey.selection-manager",[]);f.provider("nzSelectionManagerConfig",function(){var a=null,b=null;this.setSelectionClass=function(b){a=b},this.setSoftSelectionClass=function(a){b=a},this.$get=function(){return{getSelectionClass:function(){return a},getSoftSelectionClass:function(){return b}}}}),f.service("nzSelectionClassApplier",["nzSelectionManagerConfig",function(a){return{applySoftSelectionClass:function(b,c,d,e){e||(e=a.getSoftSelectionClass()),b.getSoftSelection()===d?c.addClass(e):c.removeClass(e)},applySelectionClass:function(b,c,d,e){e||(e=a.getSelectionClass()),b.isSelected(d)?c.addClass(e):c.removeClass(e)},addSoftSelectionEvents:function(b,c,f,g){g||(g=a.getSoftSelectionClass()),b.$on(d,function(a,b){b===f&&c.addClass(g)}),b.$on(e,function(a,b){b===f&&c.removeClass(g)})},addSelectionEvents:function(d,e,f,g){g||(g=a.getSelectionClass()),d.$on(b,function(a,b){b===f&&e.addClass(g)}),d.$on(c,function(a,b){b===f&&e.removeClass(g)})}}}]),f.directive("nzSelectionClass",["nzSelectionClassApplier",function(a){return{restrict:"A",controller:["$scope",function(){return{}}],require:["nzSelectionClass","^nzSelectionManager"],compile:function(b,c){var d=this.name;return{pre:function(a,b,c,d){d[0],d[1]},post:function(b,e,f,g){var h=g[0],i=g[1],j=h.selectionObj;a.applySelectionClass(i,e,j,c[d]),a.addSelectionEvents(b,e,j,c[d])}}}}}]),f.directive("nzSoftSelectionClass",["nzSelectionClassApplier",function(a){return{restrict:"A",controller:["$scope",function(){return{}}],require:["nzSoftSelectionClass","^nzSelectionManager"],compile:function(b,c){var d=this.name;return{pre:function(a,b,c,d){d[0],d[1]},post:function(b,e,f,g){var h=g[0],i=g[1],j=h.selectionObj;a.applySoftSelectionClass(i,e,j,c[d]),a.addSoftSelectionEvents(b,e,j,c[d])}}}}}]),f.directive("nzSelectable",["$parse","nzSelectionClassApplier",function(a,b){return{restrict:"A",controller:["$scope",function(){var a=this;return this.getSelectionObject=function(){return a.selectionObj},this}],require:["?^nzSelectionClass","?^nzSoftSelectionClass","^nzSelectionManager","nzSelectable"],compile:function(c,d){var e=this.name,f=a(d[e]);return{pre:function(a,c,d,e){var g=e[0],h=e[1],i=e[2],j=e[3],k=f(a);j.selectionObj=k,g?g.selectionObj=k:(b.applySelectionClass(i,c,k),b.addSelectionEvents(a,c,k)),h?h.selectionObj=k:(b.applySoftSelectionClass(i,c,k),b.addSoftSelectionEvents(a,c,k)),c.on("click",function(b){b.preventDefault(),b.stopPropagation(),b.ctrlKey?i.addSelected(c[0],!0):b.shiftKey?(i.rangeSelectFromLast(c[0]),b.preventDefault()):(i.clearSelection(),i.addSelected(c[0],!1)),a.$apply()})},post:function(){}}}}}]),f.directive("nzSelectionManager",["$parse","$document","$timeout",function(f,g){return{restrict:"A",require:"nzSelectionManager",controller:["$scope","$timeout","$element","$attrs",function(h,i,j,k){var l=this,m=a.isDefined(k.nzMultiSelect),n=null,o=null,p=function(a){l._locationOfSelection?l._locationOfSelection.assign(h,a):l._selection=a},q=function(a){l._locationOfSoftSelection?l._locationOfSoftSelection.assign(h,a):l._softSelection=a};return this.scope=h,this._locationOfSelection=a.isDefined(k.ngModel)?f(k.ngModel):null,this._locationOfSoftSelection=null,this.getAllSelectables=function(){for(var a=[],b=j[0].querySelectorAll("*[nz-selectable], *[data-nz-selectable]"),c=0;c<b.length;c++)a.push(b[c]);return a},this.toggleSoftSelectAsSelected=function(){o&&g[0].contains(o)&&l.addSelected(o,!0)},this.getSelection=function(){var a=l._selection;return l._locationOfSelection&&(a=l._locationOfSelection(h)),m&&!a&&(a=[]),a},this.getSoftSelection=function(){var a=l._softSelection;return l._locationOfSoftSelection&&(a=l._locationOfSoftSelection(h)),a},this.setSoftSelection=function(b){o=b,b=a.element(b);var c=b.controller("nzSelectable");c&&(b[0].focus(),q(c.getSelectionObject()))},this.isSelected=function(a){return m?l.getSelection().indexOf(a)>-1:l.getSelection()===a},this.addSelected=function(b,c){var d=a.element(b),e=d.controller("nzSelectable");if(e){n=b;var f=l.getSelection(),g=e.getSelectionObject();if(m){var h=f.indexOf(g);-1===h?f.push(g):c&&f.splice(h,1)}else f!==g?f=g:c&&(f=void 0);p(f),l.setSoftSelection(n)}},this.rangeSelectFromLast=function(b){if(m&&g[0].contains(n)){var c=a.element(b),d=c.controller("nzSelectable");if(d&&n){var e=n;l.clearSelection();var f=l.getAllSelectables(),h=f.indexOf(b),i=f.indexOf(e),j=f.slice(Math.min(i,h),Math.max(i,h)+1);j.forEach(function(b){b=a.element(b),l.addSelected(b)}),n=e,l.setSoftSelection(n)}}else l.addSelected(b)},this.getNextSelectableElement=function(){var b=null,c=l.getAllSelectables();if(o&&g[0].contains(o)){var d=c.indexOf(o);d++,b=c[d],b||(b=c[0])}else{var e=c.map(function(b){var b=a.element(b),c=b.controller("nzSelectable");return c?c.getSelectionObject():void 0}),f=l.getSoftSelection(),h=e.indexOf(f);b=c[h],b||(b=c[0])}return b},this.getPreviousSelectableElement=function(){var b=null,c=l.getAllSelectables();if(o&&g[0].contains(o)){var d=c.indexOf(o);d--,b=c[d],b||(b=c[c.length-1])}else{var e=c.map(function(b){var b=a.element(b),c=b.controller("nzSelectable");return c?c.getSelectionObject():void 0}),f=l.getSoftSelection(),h=e.indexOf(f);b=c[h],b||(b=c[c.length-1])}return b},this.clearSelection=function(){var b=l.getSelection();a.isArray(b)?l.getSelection().length=0:p(null)},m?h.$watchCollection(l.getSelection,function(a,d){a||(a=[]),d||(d=[]);for(var e=d.length;e--;){var f=d[e];-1===a.indexOf(f)&&h.$broadcast(c,f)}for(var g=a.length;g--;){var i=a[g];-1===d.indexOf(i)&&h.$broadcast(b,i)}}):h.$watch(l.getSelection,function(a,d){h.$broadcast(c,d),h.$broadcast(b,a)}),h.$watch(l.getSoftSelection,function(a,b){h.$broadcast(e,b),h.$broadcast(d,a)}),l}],compile:function(){this.name;return{pre:function(){},post:function(){}}}}}]),f.directive("nzSelectionKeyboardNavigation",["$parse",function(a){return{restrict:"A",require:["nzSelectionKeyboardNavigation","^nzSelectionManager"],controller:["$scope",function(){var a=this;return this.hasVerticalKeyboardNavigation=function(){return arguments[0]&&(a._hasVerticalKeyboardNavigation=!!arguments[0],a._hasHorizontalKeyboardNavigation=!a._hasVerticalKeyboardNavigation),!!a._hasVerticalKeyboardNavigation},this.hasHorizontalKeyboardNavigation=function(){return arguments[0]&&(a._hasHorizontalKeyboardNavigation=!!arguments[0],a._hasVerticalKeyboardNavigation=!a._hasHorizontalKeyboardNavigation),!!a._hasHorizontalKeyboardNavigation},a}],compile:function(b,c){return b.attr("tabindex")||b.attr("tabindex","-1"),{pre:function(b,d,e,f){var g=f[0],h=f[1];g.hasHorizontalKeyboardNavigation(!0),h._locationOfSoftSelection=a(c.softSelectModel)},post:function(a,b,c,d){var e=d[0],f=d[1],g=function(a){(13===a.keyCode||32===a.keyCode)&&(f.toggleSoftSelectAsSelected(),a.preventDefault(),a.stopPropagation())},h=function(b){if(38===b.keyCode){var c=f.getPreviousSelectableElement();f.setSoftSelection(c),b.preventDefault(),b.stopPropagation()}if(40===b.keyCode){var d=f.getNextSelectableElement();f.setSoftSelection(d),b.preventDefault(),b.stopPropagation()}g(b),a.$apply()},i=!1,j={};a.$watch(function(){return i&&(j.verticalNavigarion=e.hasVerticalKeyboardNavigation(),j.horizontalNavigarion=e.hasHorizontalKeyboardNavigation()),i=!0,j},function(a,c){a.horizontalNavigarion&&!c.horizontalNavigarion?(b.on("keydown",h),c.horizontalNavigarion=!0):!a.horizontalNavigarion&&c.horizontalNavigarion&&(b.off("keydown",h),c.horizontalNavigarion=!1),a.verticalNavigarion&&!c.verticalNavigarion||!a.verticalNavigarion&&c.verticalNavigarion},!0)}}}}}])}(angular);